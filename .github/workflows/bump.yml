name: Create dependency bump PR
on:
  # allows manual triggering from https://github.com/../../actions/workflows/bump.yml
  workflow_dispatch:
  # runs weekly on Thursday at 8:00
  schedule:
    - cron: '0 8 * * 4'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
    - uses: nomeata/haskell-bounds-bump-action@main
    - if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'Dependency bump PR workflow failed';
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'bump-failure',
          });
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          if (issues.length > 0) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues[0].number,
              body: `Still failing: ${runUrl}`,
            });
          } else {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: `The dependency bump workflow failed.\n\nSee: ${runUrl}`,
              labels: ['bump-failure'],
            });
          }
